<!doctype html>




<html class="theme-next pisces">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="CPU mode,page table," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/w0lfzhang.ico?v=5.0.2" />






<meta name="description" content="There are several microprocessor modes fot the x86 architecture. And I gonna have a detail learning about them because it’s the important part for the next implementing KVM-program.  Real mode Protect">
<meta name="keywords" content="CPU mode,page table">
<meta property="og:type" content="article">
<meta property="og:title" content="Microprocessor modes for the x86 architecture">
<meta property="og:url" content="http://yoursite.com/2018/11/08/Microprocessor-modes-for-the-x86-architecture/index.html">
<meta property="og:site_name" content="w0lfzhang&#39;s blog">
<meta property="og:description" content="There are several microprocessor modes fot the x86 architecture. And I gonna have a detail learning about them because it’s the important part for the next implementing KVM-program.  Real mode Protect">
<meta property="og:image" content="http://yoursite.com/images/4-kb-paging.png">
<meta property="og:updated_time" content="2018-12-06T04:57:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Microprocessor modes for the x86 architecture">
<meta name="twitter:description" content="There are several microprocessor modes fot the x86 architecture. And I gonna have a detail learning about them because it’s the important part for the next implementing KVM-program.  Real mode Protect">
<meta name="twitter:image" content="http://yoursite.com/images/4-kb-paging.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2018/11/08/Microprocessor-modes-for-the-x86-architecture/"/>


  <title> Microprocessor modes for the x86 architecture | w0lfzhang's blog </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="en">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-86514506-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?c3be9cb478c70b5f3b819ddd0ba381b6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">w0lfzhang's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">I love stories.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Microprocessor modes for the x86 architecture
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-11-08T15:56:18+08:00" content="2018-11-08">
              2018-11-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/kvm/" itemprop="url" rel="index">
                    <span itemprop="name">kvm</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/11/08/Microprocessor-modes-for-the-x86-architecture/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/08/Microprocessor-modes-for-the-x86-architecture/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
	 

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>There are several microprocessor modes fot the x86 architecture. And I gonna have a detail learning about them because it’s the important part for the next implementing KVM-program.</p>
<ol>
<li>Real mode</li>
<li>Protected mode</li>
<li>Virtual 8086 mode</li>
<li>System Management Mode</li>
<li>Long mode<br>We’ll discuss them one by one and how to switch the mode among them. Also, there is an other mode called unreal mode, which we don’t talk about. It’s not difficult to understand what we gonna talk about for those guys who leraned <em>Principles of Micro-computer</em>.<a id="more"></a>
</li>
</ol>
<h2 id="Modes-Introduction"><a href="#Modes-Introduction" class="headerlink" title="Modes Introduction"></a>Modes Introduction</h2><h3 id="Real-Mode"><a href="#Real-Mode" class="headerlink" title="Real Mode"></a>Real Mode</h3><p>Real mode is an operating mode of all x86-compatible CPUs. In this mode, address bus’s width is 20 and the data bus’s width is 16. The program has unlimited direct software access to all addressable memory, I/O addresses and peripheral hardware. Real mode provides no support for memory protection, multitasking, or code privilege levels. It has the following features:<br><strong>MAX 1M physical memory access</strong><br><strong>All registers 16 bits width</strong><br><strong>The default CPU operand length is only 16 bits</strong><br><strong>Addressing by form of segment:offset</strong><br><strong>No paging, no virtual address, only physical address</strong><br><strong>PhysicalAddress = Segment * 16 + Offset</strong></p>
<h3 id="Protected-Mode"><a href="#Protected-Mode" class="headerlink" title="Protected Mode"></a>Protected Mode</h3><p>Let’s first figure out what logical address and linear address are.<br>Address generated by CPU while a program is running is referred as Logical Address, which is also called Virtual Address and consists of <em>selector</em> and <em>offset</em>, selector:offset. The logical address is a virtual address and can be viewed by the user directly. The logical address is used like a reference, to access the physical address.<br>The linear address is created via adding logical address to the base of segment,<br>CS, DS, ES, SS, FS or GS, which means it’s handled by the segment selector. If paging is enabled, the linear address must be translated to physical address with the page table. If paging is not enabled, the linear address is the physical address.<br>In protected mode, the memory management contains <a href="https://www.cs.columbia.edu/~junfeng/12sp-w4118/lectures/l05-mem.pdf" target="_blank" rel="external">segmentation unit and paging unit</a>. The logical address is translated to linear address via segmentation unit and then the linear address is invisibly translated to physical address.<br>The features protected mode has:<br><strong>32 bit width data and address bus</strong><br><strong>most registers are 32 bit width except the segment registers</strong><br><strong>Protected physical memory</strong><br><strong>Segmentation And Paging addressing</strong><br><strong>Multitasking</strong><br><strong>four privilege levels: ring0-ring3</strong></p>
<h3 id="Virtual-8086-Mode"><a href="#Virtual-8086-Mode" class="headerlink" title="Virtual 8086 Mode"></a>Virtual 8086 Mode</h3><p>In the 80386 microprocessor and later, virtual 8086 mode (also called virtual real mode, V86-mode or VM86) allows the execution of real mode applications that are incapable of running directly in protected mode while the processor is running a protected mode operating system. Actually, it’s just a feature of protected mode, not a <strong>real mode</strong>.</p>
<h3 id="System-Management-Mode"><a href="#System-Management-Mode" class="headerlink" title="System Management Mode"></a>System Management Mode</h3><p>The system management mode is a special-purpose operating mode provided for handling system-wide functions like power management, system hardware control, or proprietary OEM designed code. It is intended for use only by system firmware, not by applications software or general-purpose systems software. The main benefit of SMM is that it offers a distinct and easily isolated processor environment that operates transparently to the operating system or executive and software applications.</p>
<h3 id="Long-Mode"><a href="#Long-Mode" class="headerlink" title="Long Mode"></a>Long Mode</h3><p>In the x86-64 computer architecture, long mode is the mode where a 64-bit operating system can access 64-bit instructions and registers. 64-bit programs are run in a sub-mode called 64-bit mode, while 32-bit programs and 16-bit protected mode programs are executed in a sub-mode called compatibility mode. Real mode or virtual 8086 mode programs cannot be natively run in long mode.<br>64-bit mode provides a lot of new features, 64-bit registers, eight new general-purpose registers(r8-r15) and so on.<br>Not all 64-bit processors can use the long mode, you can use CPUID instruction to detect the presence of long mode.</p>
<h2 id="Modes-Switching"><a href="#Modes-Switching" class="headerlink" title="Modes Switching"></a>Modes Switching</h2><p>The Control Registers could change or control the CPU’s behaviour. Common tasks performed by control registers include interrupt control, switching the addressing mode, paging control, and coprocessor control. Normally, there are 8 control registers in x86 series, while in x86_64 series, three addtional control registers are added: EFER, CR8 and XCR0.<br>More details about control registers, you can view <a href="https://en.wikipedia.org/wiki/Control_register" target="_blank" rel="external">this page</a>.</p>
<h3 id="Entering-protected-mode"><a href="#Entering-protected-mode" class="headerlink" title="Entering protected mode"></a>Entering protected mode</h3><p>Entering the protected mode from real mode, we just enable CR0’s bit 0, which is also called PE. And more about paging, see the part 2 of chapter 5, <em>AMD64 Architecture Programmer’s Manual, Volume 2</em>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">; set PE bit</div><div class="line">cli            ; disable interrupts</div><div class="line">lgdt [gdtr]    ; load GDT register with start address of Global Descriptor Table</div><div class="line">mov eax, cr0 </div><div class="line">or al, 1       ; set PE (Protection Enable) bit in CR0 (Control Register 0)</div><div class="line">mov cr0, eax</div><div class="line"> </div><div class="line">; Perform far jump to selector 08h (offset into GDT, pointing at a 32bit PM code segment descriptor) </div><div class="line">; to load CS with proper PM32 descriptor)</div><div class="line">jmp 08h:PModeMain</div><div class="line"> </div><div class="line">PModeMain:</div><div class="line">; load DS, ES, FS, GS, SS, ESP</div></pre></td></tr></table></figure></p>
<h3 id="Entering-V86-mode"><a href="#Entering-V86-mode" class="headerlink" title="Entering V86 mode"></a>Entering V86 mode</h3><p>The CPU is executing in virtual 86 mode when the VM bit (bit 17) is set in the EFLAGS register.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">; you should declare this function as :</div><div class="line">; extern void entering_v86(uint32_t ss, uint32_t esp, uint32_t cs, uint32_t eip);</div><div class="line">entering_v86:</div><div class="line">   mov epb, esp               ; save stack pointer</div><div class="line"></div><div class="line">   push dword  [ebp+4]        ; ss</div><div class="line">   push dword  [ebp+8]        ; esp</div><div class="line">   pushfd                     ; eflags</div><div class="line">   or dword [esp], (1 &lt;&lt; 17)  ; set VM flags</div><div class="line">   push dword [ebp+12]        ; cs</div><div class="line">   push dword  [ebp+16]       ; eip</div><div class="line">   iret</div></pre></td></tr></table></figure></p>
<h3 id="Entering-long-mode"><a href="#Entering-long-mode" class="headerlink" title="Entering long mode"></a>Entering long mode</h3><p>Then we talk about how to entering long mode. The most complicated part is to set up the paging.<br>Before activating long mode, <a href="https://en.wikipedia.org/wiki/Physical_Address_Extension" target="_blank" rel="external">PAE(Physical Address Extension)</a> must be enabled by setting CR4.PAE to 1. On 32-bit OS, enabling PAE makes it possible to access more than 4GB RAM, which translates the 32-bit virtual address to 36-bit physical address. While on x86_64 archs, enabling PAE supports mapping of 64-bit virtual address into 52-bit physical address. With PAE paging in long mode, we have page-directory pointer table(PDPT), the page-directory talbe(PDT), the page table(PT) and another new table that is page-map level-4 table(PML4T). The following is a 4-KB page translation in long mode.<br><img src="/images/4-kb-paging.png" width="600" height="300"><br>First we should disable the old paging first (you can skip this if you never set up paging in protected mode) as this is required.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mov eax, cr0                                   ; Set the A-register to control register 0.</div><div class="line">and eax, 01111111111111111111111111111111b     ; Clear the PG-bit, which is bit 31.</div><div class="line">mov cr0, eax</div></pre></td></tr></table></figure></p>
<p>In long mode, the CR3 register is used to point to the PML4 base address(physical address). First clearing the tables:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mov edi, 0x1000    ; Set the destination index to 0x1000.</div><div class="line">mov cr3, edi       ; Set control register 3 to the destination index.</div><div class="line">xor eax, eax       ; Nullify the A-register.</div><div class="line">mov ecx, 4096      ; Set the count to 4096.</div><div class="line">rep stosd          ; Clear the memory.</div><div class="line">mov edi, cr3       ; Set the destination index to control register 3.</div></pre></td></tr></table></figure></p>
<p>It’s clear PML4T is located at 0x1000, and we gonna make PDPT located at 0x2000, PDT at 0x3000 and PT at 0x400.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mov DWORD [edi], 0x2003      ; Set the uint32_t at the destination index to 0x2003.</div><div class="line">add edi, 0x1000              ; Add 0x1000 to the destination index.</div><div class="line">mov DWORD [edi], 0x3003      ; Set the uint32_t at the destination index to 0x3003.</div><div class="line">add edi, 0x1000              ; Add 0x1000 to the destination index.</div><div class="line">mov DWORD [edi], 0x4003      ; Set the uint32_t at the destination index to 0x4003.</div><div class="line">add edi, 0x1000</div></pre></td></tr></table></figure></p>
<p>Notice that the first 2 bits is set, which indicates the page is present and it’s readable and writeable. Then we gonna map the first 2M memory:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">    mov ebx, 0x00000003          ; Set the B-register to 0x00000003.</div><div class="line">    mov ecx, 512                 ; Set the C-register to 512.</div><div class="line"> </div><div class="line">.SetEntry:</div><div class="line">    mov DWORD [edi], ebx         ; Set the uint32_t at the destination index to the B-register.</div><div class="line">    add ebx, 0x1000              ; Add 0x1000 to the B-register.</div><div class="line">    add edi, 8                   ; Add eight to the destination index.</div><div class="line">    loop .SetEntry               ; Set the next entry.</div></pre></td></tr></table></figure></p>
<p>We’ve finished setting up the page table. Next is to enable PAE-paging by setting CR4.PAE:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mov eax, cr4                 ; Set the A-register to control register 4.</div><div class="line">or eax, 1 &lt;&lt; 5               ; Set the PAE-bit, which is the 6th bit (bit 5).</div><div class="line">mov cr4, eax</div></pre></td></tr></table></figure></p>
<p>And you can enter long mode from real mode or protected mode.<br>Switching from real mode:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mov ecx, 0xC0000080          ; Set the C-register to 0xC0000080, which is the EFER MSR.</div><div class="line">rdmsr                        ; Read from the model-specific register.</div><div class="line">or eax, 1 &lt;&lt; 8               ; Set the LM-bit which is the 9th bit (bit 8).</div><div class="line">wrmsr </div><div class="line"></div><div class="line">; enabling paging and protected mode.</div><div class="line">mov eax, cr0                 ; Set the A-register to control register 0.</div><div class="line">or eax, 1 &lt;&lt; 31 | 1 &lt;&lt; 0     ; Set the PG-bit, which is the 31nd bit, and the PM-bit, which is the 0th bit.</div><div class="line">mov cr0, eax</div></pre></td></tr></table></figure></p>
<p>Switching from protected mode:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mov ecx, 0xC0000080          ; Set the C-register to 0xC0000080, which is the EFER MSR.</div><div class="line">rdmsr                        ; Read from the model-specific register.</div><div class="line">or eax, 1 &lt;&lt; 8               ; Set the LM-bit which is the 9th bit (bit 8).</div><div class="line">wrmsr</div><div class="line"></div><div class="line">; enabling paging</div><div class="line">mov eax, cr0                 ; Set the A-register to control register 0.</div><div class="line">or eax, 1 &lt;&lt; 31              ; Set the PG-bit, which is the 32nd bit (bit 31).</div><div class="line">mov cr0, eax</div></pre></td></tr></table></figure></p>
<p>More about model-specific register (MSR), see <a href="http://www.sandpile.org/x86/msr.htm" target="_blank" rel="external">here</a>.<br>After these operations, we’re in compatibility mode. The last thing we should do is to load a GDT like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">GDT64:                           ; Global Descriptor Table (64-bit).</div><div class="line">    .Null: equ $ - GDT64         ; The null descriptor.</div><div class="line">    dw 0xFFFF                    ; Limit (low).</div><div class="line">    dw 0                         ; Base (low).</div><div class="line">    db 0                         ; Base (middle)</div><div class="line">    db 0                         ; Access.</div><div class="line">    db 1                         ; Granularity.</div><div class="line">    db 0                         ; Base (high).</div><div class="line">    .Code: equ $ - GDT64         ; The code descriptor.</div><div class="line">    dw 0                         ; Limit (low).</div><div class="line">    dw 0                         ; Base (low).</div><div class="line">    db 0                         ; Base (middle)</div><div class="line">    db 10011010b                 ; Access (exec/read).</div><div class="line">    db 10101111b                 ; Granularity, 64 bits flag, limit19:16.</div><div class="line">    db 0                         ; Base (high).</div><div class="line">    .Data: equ $ - GDT64         ; The data descriptor.</div><div class="line">    dw 0                         ; Limit (low).</div><div class="line">    dw 0                         ; Base (low).</div><div class="line">    db 0                         ; Base (middle)</div><div class="line">    db 10010010b                 ; Access (read/write).</div><div class="line">    db 00000000b                 ; Granularity.</div><div class="line">    db 0                         ; Base (high).</div><div class="line">    .Pointer:                    ; The GDT-pointer.</div><div class="line">    dw $ - GDT64 - 1             ; Limit.</div><div class="line">    dq GDT64                     ; Base.</div></pre></td></tr></table></figure></p>
<p>Last we jump to the 64-bit world:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lgdt [GDT64.Pointer]         ; Load the 64-bit global descriptor table.</div><div class="line">jmp GDT64.Code:Realm64       ; Set the code segment and enter 64-bit long mode</div></pre></td></tr></table></figure></p>
<p>You can do what you want to do now:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">; Use 64-bit.</div><div class="line">[BITS 64]</div><div class="line"> </div><div class="line">Realm64:</div><div class="line">    cli                           ; Clear the interrupt flag, not setting IDT.</div><div class="line">    mov ax, GDT64.Data            ; Set the A-register to the data descriptor.</div><div class="line">    mov ds, ax                    ; Set the data segment to the A-register.</div><div class="line">    mov es, ax                    ; Set the extra segment to the A-register.</div><div class="line">    mov fs, ax                    ; Set the F-segment to the A-register.</div><div class="line">    mov gs, ax                    ; Set the G-segment to the A-register.</div><div class="line">    mov ss, ax                    ; Set the stack segment to the A-register.</div><div class="line">    mov edi, 0xB8000              ; Set the destination index to 0xB8000.</div><div class="line">    mov rax, 0x1F201F201F201F20   ; Set the A-register to 0x1F201F201F201F20.</div><div class="line">    mov ecx, 500                  ; Set the C-register to 500.</div><div class="line">    rep stosq                     ; Clear the screen.</div><div class="line">    hlt                           ; Halt the processor.</div></pre></td></tr></table></figure></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://blog.csdn.net/rosetta/article/details/8933200" target="_blank" rel="external">实模式和保护模式区别及寻址方式</a><br><a href="https://blog.csdn.net/laviolette/article/details/51658650" target="_blank" rel="external">实模式和保护模式</a><br><a href="https://en.wikipedia.org/wiki/System_Management_Mode" target="_blank" rel="external">System Management Mode</a><br><a href="https://wiki.osdev.org/Protected_Mode" target="_blank" rel="external">Protected Mode</a><br><a href="https://wiki.osdev.org/Virtual_8086_Mode" target="_blank" rel="external">Virtual 8086 Mode</a><br><a href="https://wiki.osdev.org/Setting_Up_Long_Mode" target="_blank" rel="external">Setting Up Long Mode</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CPU-mode/" rel="tag">#CPU mode</a>
          
            <a href="/tags/page-table/" rel="tag">#page table</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/05/Blizzard-CTF-2017-Strng/" rel="next" title="Blizzard CTF 2017 Strng">
                <i class="fa fa-chevron-left"></i> Blizzard CTF 2017 Strng
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/05/xnuca-SSD-QEMU-escape/" rel="prev" title="XNUCA SSD QEMU ESCAPE">
                XNUCA SSD QEMU ESCAPE <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/wolf.jpg"
               alt="w0lfzhang" />
          <p class="site-author-name" itemprop="name">w0lfzhang</p>
          <p class="site-description motion-element" itemprop="description">Go slowly! Just slowly!</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">64</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">105</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Modes-Introduction"><span class="nav-number">1.</span> <span class="nav-text">Modes Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Real-Mode"><span class="nav-number">1.1.</span> <span class="nav-text">Real Mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Protected-Mode"><span class="nav-number">1.2.</span> <span class="nav-text">Protected Mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Virtual-8086-Mode"><span class="nav-number">1.3.</span> <span class="nav-text">Virtual 8086 Mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#System-Management-Mode"><span class="nav-number">1.4.</span> <span class="nav-text">System Management Mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Long-Mode"><span class="nav-number">1.5.</span> <span class="nav-text">Long Mode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Modes-Switching"><span class="nav-number">2.</span> <span class="nav-text">Modes Switching</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Entering-protected-mode"><span class="nav-number">2.1.</span> <span class="nav-text">Entering protected mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Entering-V86-mode"><span class="nav-number">2.2.</span> <span class="nav-text">Entering V86 mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Entering-long-mode"><span class="nav-number">2.3.</span> <span class="nav-text">Entering long mode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">3.</span> <span class="nav-text">References</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">w0lfzhang</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

<span id="busuanzi_container_site_pv">
    &nbsp; | &nbsp;Visited <span id="busuanzi_value_site_pv"></span> times
</span>



        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'w0lfzhang';
      var disqus_identifier = '2018/11/08/Microprocessor-modes-for-the-x86-architecture/';
      var disqus_title = "Microprocessor modes for the x86 architecture";
      var disqus_url = 'http://yoursite.com/2018/11/08/Microprocessor-modes-for-the-x86-architecture/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      
    </script>
  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
